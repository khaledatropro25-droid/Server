name: Ultimate-Stealth-RDP-Final

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019
    timeout-minutes: 360

    steps:
    # 1️⃣ تنظيف خفيف وآمن
    - name: Free Up Space (Safe)
      shell: powershell
      run: |
        Remove-Item "C:\ProgramData\Package Cache" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Host "Disk cleaned safely."

    # 2️⃣ تثبيت Tailscale
    - name: Install Tailscale
      shell: powershell
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale.exe
        Start-Process tailscale.exe -ArgumentList "/quiet","/norestart" -Wait

    # 3️⃣ الاتصال بـ Tailscale
    - name: Connect Tailscale
      shell: powershell
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up `
        --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
        --accept-routes `
        --hostname=Ghost-${{ github.run_number }}

    # 4️⃣ تفعيل RDP
    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
        -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    # 5️⃣ إنشاء يوزر ثابت وآمن (إنت بس اللي عارفه)
    - name: Create Secure Fixed User
      shell: powershell
      run: |
        $user = "${{ secrets.RDP_USERNAME }}"
        $plainPass = "${{ secrets.RDP_PASSWORD }}"

        if ([string]::IsNullOrWhiteSpace($user) -or [string]::IsNullOrWhiteSpace($plainPass)) {
          Write-Error "RDP credentials are missing!"
          exit 1
        }

        $pass = ConvertTo-SecureString $plainPass -AsPlainText -Force

        New-LocalUser $user -Password $pass -FullName "Authorized Admin" -Description "Secure RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

        Write-Host "Secure RDP user created."

    # 6️⃣ عرض IP بتاع Tailscale
    - name: Show Tailscale IP
      shell: powershell
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" ip -4

    # 7️⃣ Anti-Idle ذكي وهادي
    - name: Smart Anti-Idle
      shell: powershell
      run: |
        $targets = @("1.1.1.1","8.8.8.8","github.com","microsoft.com")
        $wsh = New-Object -ComObject WScript.Shell

        for ($i = 0; $i -lt 180; $i++) {
          $t = Get-Random $targets
          Test-NetConnection $t -Port 80 | Out-Null
          $wsh.SendKeys("{NUMLOCK}")
          Start-Sleep -Seconds (Get-Random -Minimum 60 -Maximum 120)
        }

    # 8️⃣ خروج نظيف
    - name: Graceful Exit
      shell: powershell
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" logout
        Write-Host "Session closed cleanly."
